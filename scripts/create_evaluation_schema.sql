-- Create Evaluation Center Tables

-- 1. Tests Catalog
CREATE TABLE IF NOT EXISTS evaluation_tests (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    type TEXT NOT NULL CHECK (type IN ('psychometric', 'cognitive', 'language')),
    time_limit_minutes INTEGER,
    config JSONB DEFAULT '{}'::jsonb, -- For specific settings like "randomize_questions"
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Question Bank
CREATE TABLE IF NOT EXISTS evaluation_questions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    test_id BIGINT REFERENCES evaluation_tests(id) ON DELETE CASCADE,
    question_text TEXT NOT NULL,
    question_type TEXT NOT NULL CHECK (question_type IN ('likert', 'multiple_choice', 'text', 'boolean')),
    options JSONB, -- Array of options for multiple choice: [{"label": "A", "value": 1}, ...]
    correct_answer TEXT, -- For cognitive/language tests
    trait_category TEXT, -- For psychometric (e.g., 'openness', 'conscientiousness')
    is_reverse_scored BOOLEAN DEFAULT FALSE, -- For psychometric
    order_index INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. Candidate Results (Test Sessions)
CREATE TABLE IF NOT EXISTS candidate_results (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    candidate_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
    test_id BIGINT REFERENCES evaluation_tests(id) ON DELETE CASCADE,
    status TEXT NOT NULL CHECK (status IN ('started', 'completed')) DEFAULT 'started',
    score_data JSONB, -- Stores the final calculated scores (e.g., { "openness": 80, "neuroticism": 20 })
    started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    completed_at TIMESTAMP WITH TIME ZONE,
    UNIQUE(candidate_id, test_id) -- Prevent duplicate active sessions for same test? Maybe allow retakes later.
);

-- 4. Candidate Responses (Detailed Log)
CREATE TABLE IF NOT EXISTS candidate_responses (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    result_id BIGINT REFERENCES candidate_results(id) ON DELETE CASCADE,
    question_id BIGINT REFERENCES evaluation_questions(id) ON DELETE CASCADE,
    response_value TEXT, -- The value selected/entered by the user
    response_time_ms INTEGER, -- Time taken to answer (for biometrics/analysis)
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- RLS Policies

-- Enable RLS
ALTER TABLE evaluation_tests ENABLE ROW LEVEL SECURITY;
ALTER TABLE evaluation_questions ENABLE ROW LEVEL SECURITY;
ALTER TABLE candidate_results ENABLE ROW LEVEL SECURITY;
ALTER TABLE candidate_responses ENABLE ROW LEVEL SECURITY;

-- Policies for evaluation_tests (Public read, Admin write)
CREATE POLICY "Tests are viewable by everyone" ON evaluation_tests FOR SELECT USING (true);

-- Policies for evaluation_questions (Public read, Admin write)
CREATE POLICY "Questions are viewable by everyone" ON evaluation_questions FOR SELECT USING (true);

-- Policies for candidate_results (Users can see/insert their own)
CREATE POLICY "Users can view own results" ON candidate_results FOR SELECT USING (auth.uid() = candidate_id);
CREATE POLICY "Users can insert own results" ON candidate_results FOR INSERT WITH CHECK (auth.uid() = candidate_id);
CREATE POLICY "Users can update own results" ON candidate_results FOR UPDATE USING (auth.uid() = candidate_id);

-- Policies for candidate_responses (Users can see/insert their own)
CREATE POLICY "Users can view own responses" ON candidate_responses FOR SELECT USING (
    EXISTS (SELECT 1 FROM candidate_results WHERE id = candidate_responses.result_id AND candidate_id = auth.uid())
);
CREATE POLICY "Users can insert own responses" ON candidate_responses FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM candidate_results WHERE id = candidate_responses.result_id AND candidate_id = auth.uid())
);

-- Seed Initial Data: Psychometric Test (Big 5)
INSERT INTO evaluation_tests (title, description, type, time_limit_minutes)
VALUES 
('Perfil Conductual (Big 5)', 'Evaluaci√≥n de rasgos de personalidad en el entorno laboral.', 'psychometric', 15)
ON CONFLICT DO NOTHING;
